# Using Elasticsearch & Kibana w/ Serilog: Proof of Concept

## Elasticsearch Serilog Sink

This sink efficiently forwards logs generated by our microservices to an Elasticsearch cluster, enabling centralized logging and analysis.

### Setup

The setup involves installing the sink nuget package and integrating the Serilog logging library with each microservice. Serilog is configured to use the Elasticsearch sink within the microservices’ codebase. This configuration is done through the appsettings.json file or directly within the code, depending on our deployment strategy and the need for dynamic configuration.

### Configuration

In the configuration, we specify the Elasticsearch node(s) that Serilog will send logs to. Here, it’s crucial to ensure that the Elasticsearch nodes are accessible from within the microservices, especially when running in a containerized environment. We also configure the batch posting interval and the event level to control the frequency and verbosity of the log data. For instance:

``` json
"Serilog": {
    "Using": ["Serilog.Sinks.Elasticsearch"],
    "MinimumLevel": "Information",
    "WriteTo": [
        {
            "Name": "Elasticsearch",
            "Args": {
                "nodeUris": "http://elasticsearch:9200",
                "indexFormat": "serilog-logs-{0:yyyy.MM}"
            }
        }
    ],
    "Enrich": [ "FromLogContext", "WithMachineName", "WithThreadId" ],
    "Properties": {
        "Application": "MyMicroserviceApp"
    }
}
```

In this example, the `nodeUris` property is set to the Elasticsearch cluster's address. The indexFormat specifies the naming convention for indices created in Elasticsearch, which includes a timestamp for easy organization and retrieval. The Enrich section adds additional context to each log entry, such as the machine name and thread ID, enhancing the traceability and debuggability of the logs.

## Structured Logging

One of the key strengths of Serilog is its support for structured logging. Unlike traditional logging, which deals with unstructured text, structured logging represents log data as structured data. This approach is particularly powerful when combined with Elasticsearch and Kibana, as it allows for more efficient data analysis and querying.

### Structured format

Structured logging in Serilog involves logging complex data types like objects and arrays, which are then serialized into a structured format (typically JSON). This structure enables us to query specific fields within logs, making it easier to filter and analyze log data in Elasticsearch and visualize it in Kibana.

For example, instead of logging a plain text message:

``` csharp
Log.Information("Order processed for customer: {CustomerId}, total amount: {Amount}", customerId, amount);
```

This log statement includes structured data - CustomerId and Amount, which can be directly queried in Elasticsearch or used to create specific visualizations in Kibana.

### Log enrichers

Log enrichers in Serilog allow for the addition of extra information to log entries, enhancing their usefulness in analysis. These enrichers can add context-specific data, which is not available in the default log context.

#### Examples of Custom Enrichers

1. Correlation ID Enricher: Adds a unique identifier to every log entry, which can be used to trace logs across different microservices and requests.
2. User Context Enricher: Appends user-specific information, such as user ID or role, to logs, aiding in auditing and user behavior analysis.
3. Environment Enricher: Includes details about the environment (like Production, Staging, Development) where the log was generated.

#### Implementation

Implementing a custom enricher involves creating a class that implements the ILogEventEnricher interface and then adding this enricher to the Serilog configuration. For instance:

``` csharp
public class UserContextEnricher : ILogEventEnricher
{
    public void Enrich(LogEvent logEvent, ILogEventPropertyFactory propertyFactory)
    {
        // Logic to add user-specific information to the log event
    }
}

// In the Serilog configuration
Log.Logger = new LoggerConfiguration()
    .Enrich.With(new UserContextEnricher())
    .CreateLogger();
```

### Benefits in Elasticsearch & Kibana

* **Improved Querying**: Structured data and enriched properties make it easier to build precise queries in Elasticsearch.
* **Enhanced Visualization**: Kibana can utilize structured data to create more informative and relevant visualizations.
* **Better Context**: Enrichers add vital context to logs, improving the ability to diagnose and understand issues.

## Benefits using microservices architecture

### Enhanced Log Management

In a microservices architecture, each service operates independently, which can lead to a challenge in managing and correlating logs. The combination of Serilog for structured logging, Elasticsearch for centralized log storage, and Kibana for log analysis and visualization, addresses this challenge effectively.

### Scalable and flexible logging

* **Serilog**: Allows dynamic log level changes and different outputs (like console, file, Elasticsearch) which can be configured per service basis.
* **Elasticsearch**: Scales horizontally to handle increased log data as the number of microservices grows.
